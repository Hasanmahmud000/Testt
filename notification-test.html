<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notification Test - CricStreamZone</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #111;
            color: #fff;
            padding: 20px;
            max-width: 600px;
            margin: 0 auto;
        }
        .test-container {
            background: #222;
            padding: 30px;
            border-radius: 15px;
            border: 2px solid #0af;
        }
        .test-btn {
            background: #0af;
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 8px;
            cursor: pointer;
            margin: 10px;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        .test-btn:hover {
            background: #0099cc;
            transform: translateY(-2px);
        }
        .test-btn:disabled {
            background: #555;
            cursor: not-allowed;
            transform: none;
        }
        .status {
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            font-weight: bold;
        }
        .status.success {
            background: rgba(0, 255, 0, 0.2);
            border: 1px solid #00ff00;
        }
        .status.error {
            background: rgba(255, 0, 0, 0.2);
            border: 1px solid #ff0000;
        }
        .status.info {
            background: rgba(0, 170, 255, 0.2);
            border: 1px solid #0af;
        }
        .log {
            background: #000;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            font-family: monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #333;
        }
        .sw-status {
            background: #333;
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            font-size: 14px;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            background: #1a1a1a;
            border-radius: 10px;
            border-left: 4px solid #0af;
        }
        .test-section h3 {
            color: #0af;
            margin-top: 0;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>ğŸ”” CricStreamZone Notification Test Center</h1>
        <p>Complete notification system testing and debugging tool</p>
        
        <div id="permissionStatus" class="status info">
            ğŸ” Checking notification permission...
        </div>

        <div id="swStatus" class="sw-status">
            ğŸ”§ Checking Service Worker status...
        </div>
        
        <div class="test-section">
            <h3>ğŸ”‘ Permission & Setup</h3>
            <button id="requestPermission" class="test-btn">ğŸ”” Request Permission</button>
            <button id="checkSW" class="test-btn">ğŸ”§ Check Service Worker</button>
            <button id="registerSW" class="test-btn">ğŸ“ Register Service Worker</button>
        </div>

        <div class="test-section">
            <h3>ğŸ§ª Basic Notification Tests</h3>
            <button id="testBasic" class="test-btn" disabled>ğŸ§ª Test Basic Notification</button>
            <button id="testWithIcon" class="test-btn" disabled>ğŸ–¼ï¸ Test with Icon</button>
            <button id="testPersistent" class="test-btn" disabled>ğŸ“Œ Test Persistent</button>
        </div>

        <div class="test-section">
            <h3>ğŸ Cricket Match Notifications</h3>
            <button id="test15min" class="test-btn" disabled>ğŸ• Test 15min Alert</button>
            <button id="test5min" class="test-btn" disabled>â° Test 5min Alert</button>
            <button id="testLive" class="test-btn" disabled>ğŸ”´ Test Live Alert</button>
            <button id="testEnd" class="test-btn" disabled>ğŸ Test End Alert</button>
        </div>

        <div class="test-section">
            <h3>ğŸ“± Advanced Features</h3>
            <button id="testVibration" class="test-btn" disabled>ğŸ“³ Test Vibration</button>
            <button id="testActions" class="test-btn" disabled>âš¡ Test Action Buttons</button>
            <button id="testSound" class="test-btn" disabled>ğŸ”Š Test with Sound</button>
            <button id="testBadge" class="test-btn" disabled>ğŸ·ï¸ Test with Badge</button>
        </div>

        <div class="test-section">
            <h3>ğŸ› ï¸ Utilities</h3>
            <button id="clearAll" class="test-btn">ğŸ—‘ï¸ Clear Log</button>
            <button id="testAll" class="test-btn" disabled>ğŸš€ Run All Tests</button>
            <button id="exportLog" class="test-btn">ğŸ“¤ Export Log</button>
        </div>
        
        <div class="log" id="testLog">
            <div>ğŸ“‹ Notification test log - Ready to start testing...</div>
        </div>
    </div>

    <script>
        // Fixed Notification Tester with Service Worker Support
        class NotificationTester {
            constructor() {
                this.log = document.getElementById('testLog');
                this.swRegistration = null;
                this.init();
            }

            async init() {
                this.addLog('ğŸš€ CricStreamZone Notification Tester v2.0 initialized');
                await this.checkServiceWorker();
                this.updatePermissionStatus();
                this.bindEvents();
            }

            addLog(message, type = 'info') {
                const time = new Date().toLocaleTimeString();
                const logEntry = document.createElement('div');
                const icon = type === 'error' ? 'âŒ' : type === 'success' ? 'âœ…' : type === 'warning' ? 'âš ï¸' : 'ğŸ“‹';
                logEntry.innerHTML = `[${time}] ${icon} ${message}`;
                logEntry.style.color = type === 'error' ? '#ff6b6b' : type === 'success' ? '#51cf66' : type === 'warning' ? '#ffd43b' : '#fff';
                this.log.appendChild(logEntry);
                this.log.scrollTop = this.log.scrollHeight;
            }

            async checkServiceWorker() {
                const swStatus = document.getElementById('swStatus');
                
                if ('serviceWorker' in navigator) {
                    try {
                        // Check if already registered
                        this.swRegistration = await navigator.serviceWorker.getRegistration();
                        
                        if (this.swRegistration) {
                            swStatus.innerHTML = 'âœ… Service Worker is registered and active';
                            swStatus.style.background = 'rgba(0, 255, 0, 0.2)';
                            this.addLog('âœ… Service Worker found and active', 'success');
                        } else {
                            swStatus.innerHTML = 'âš ï¸ Service Worker not registered - Click "Register Service Worker"';
                            swStatus.style.background = 'rgba(255, 212, 59, 0.2)';
                            this.addLog('âš ï¸ Service Worker not registered', 'warning');
                        }
                    } catch (error) {
                        swStatus.innerHTML = 'âŒ Service Worker check failed';
                        swStatus.style.background = 'rgba(255, 0, 0, 0.2)';
                        this.addLog(`âŒ Service Worker check error: ${error.message}`, 'error');
                    }
                } else {
                    swStatus.innerHTML = 'âŒ Service Worker not supported in this browser';
                    swStatus.style.background = 'rgba(255, 0, 0, 0.2)';
                    this.addLog('âŒ Service Worker not supported', 'error');
                }
            }

            async registerServiceWorker() {
                if (!('serviceWorker' in navigator)) {
                    this.addLog('âŒ Service Worker not supported', 'error');
                    return;
                }

                try {
                    this.addLog('ğŸ”§ Registering Service Worker...');
                    this.swRegistration = await navigator.serviceWorker.register('/sw.js');
                    
                    await navigator.serviceWorker.ready;
                    this.addLog('âœ… Service Worker registered successfully', 'success');
                    await this.checkServiceWorker();
                    this.updatePermissionStatus();
                } catch (error) {
                    this.addLog(`âŒ Service Worker registration failed: ${error.message}`, 'error');
                }
            }

            updatePermissionStatus() {
                const status = document.getElementById('permissionStatus');
                const buttons = document.querySelectorAll('.test-btn:not(#requestPermission):not(#clearAll):not(#checkSW):not(#registerSW):not(#exportLog)');
                
                switch (Notification.permission) {
                    case 'granted':
                        status.className = 'status success';
                        status.innerHTML = 'âœ… Notifications ENABLED - All tests available';
                        buttons.forEach(btn => btn.disabled = false);
                        document.getElementById('requestPermission').disabled = true;
                        this.addLog('âœ… Notification permission granted', 'success');
                        break;
                    case 'denied':
                        status.className = 'status error';
                        status.innerHTML = 'âŒ Notifications BLOCKED - Enable in browser settings';
                        buttons.forEach(btn => btn.disabled = true);
                        this.addLog('âŒ Notification permission denied', 'error');
                        break;
                    default:
                        status.className = 'status info';
                        status.innerHTML = 'â³ Permission not requested - Click "Request Permission"';
                        buttons.forEach(btn => btn.disabled = true);
                        this.addLog('â³ Notification permission not requested');
                }
            }

            async requestPermission() {
                try {
                    this.addLog('ğŸ”” Requesting notification permission...');
                    const permission = await Notification.requestPermission();
                    this.addLog(`ğŸ“‹ Permission result: ${permission}`);
                    this.updatePermissionStatus();
                    
                    if (permission === 'granted') {
                        await this.showNotification('ğŸ‰ Permission Granted!', 'Notifications are now enabled for CricStreamZone');
                    }
                } catch (error) {
                    this.addLog(`âŒ Error requesting permission: ${error.message}`, 'error');
                }
            }

            async showNotification(title, body, options = {}) {
                if (Notification.permission !== 'granted') {
                    this.addLog('âŒ Cannot show notification - permission not granted', 'error');
                    return;
                }

                const defaultOptions = {
                    icon: 'https://i.postimg.cc/3rPWWckN/icon-192.png',
                    badge: 'https://i.postimg.cc/3rPWWckN/icon-192.png',
                    requireInteraction: false,
                    silent: false,
                    tag: `test-${Date.now()}`,
                    ...options
                };

                try {
                    // Use Service Worker if available, otherwise fallback to direct notification
                    if (this.swRegistration && this.swRegistration.active) {
                        this.addLog(`ğŸ”§ Using Service Worker notification: ${title}`);
                        await this.swRegistration.showNotification(title, {
                            body: body,
                            ...defaultOptions
                        });
                    } else {
                        this.addLog(`ğŸ“± Using direct notification: ${title}`);
                        const notification = new Notification(title, {
                            body: body,
                            ...defaultOptions
                        });

                        notification.onclick = () => {
                            this.addLog(`ğŸ–±ï¸ Notification clicked: ${title}`, 'success');
                            notification.close();
                        };

                        notification.onclose = () => {
                            this.addLog(`âŒ Notification closed: ${title}`);
                        };

                        notification.onerror = (error) => {
                            this.addLog(`âŒ Notification error: ${error}`, 'error');
                        };

                        // Auto close after 10 seconds
                        setTimeout(() => {
                            notification.close();
                        }, 10000);
                    }

                    this.addLog(`âœ… Notification sent successfully: ${title}`, 'success');

                } catch (error) {
                    this.addLog(`âŒ Error showing notification: ${error.message}`, 'error');
                }
            }

            async runAllTests() {
                this.addLog('ğŸš€ Running all notification tests...');
                
                const tests = [
                    { title: 'ğŸ§ª Basic Test', body: 'Basic notification test' },
                    { title: 'ğŸ• 15min Alert', body: 'Match starts in 15 minutes', options: { vibrate: [300, 100, 300] } },
                    { title: 'â° 5min Alert', body: 'Match starts in 5 minutes', options: { vibrate: [500, 200, 500] } },
                    { title: 'ğŸ”´ Live Alert', body: 'Match is now LIVE!', options: { vibrate: [1000, 300, 1000] } },
                    { title: 'ğŸ End Alert', body: 'Match has ended', options: { requireInteraction: false } }
                ];

                for (let i = 0; i < tests.length; i++) {
                    const test = tests[i];
                    await this.showNotification(test.title, test.body, test.options);
                    await new Promise(resolve => setTimeout(resolve, 2000)); // 2 second delay between tests
                }

                this.addLog('âœ… All tests completed', 'success');
            }

            exportLog() {
                const logContent = this.log.innerText;
                const blob = new Blob([logContent], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `cricstreamzone-notification-test-${new Date().toISOString().slice(0, 10)}.txt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                this.addLog('ğŸ“¤ Test log exported', 'success');
            }

            bindEvents() {
                // Permission & Setup
                document.getElementById('requestPermission').onclick = () => this.requestPermission();
                document.getElementById('checkSW').onclick = () => this.checkServiceWorker();
                document.getElementById('registerSW').onclick = () => this.registerServiceWorker();

                // Basic Tests
                document.getElementById('testBasic').onclick = () => {
                    this.showNotification(
                        'ğŸ§ª Basic Test',
                        'This is a basic notification test from CricStreamZone'
                    );
                };

                document.getElementById('testWithIcon').onclick = () => {
                    this.showNotification(
                        'ğŸ–¼ï¸ Icon Test',
                        'This notification includes the CricStreamZone icon',
                        {
                            icon: 'https://i.postimg.cc/3rPWWckN/icon-192.png'
                        }
                    );
                };

                document.getElementById('testPersistent').onclick = () => {
                    this.showNotification(
                        'ğŸ“Œ Persistent Test',
                        'This notification requires user interaction to close',
                        {
                            requireInteraction: true,
                            tag: 'persistent-test'
                        }
                    );
                };

                // Cricket Match Tests
                document.getElementById('test15min').onclick = () => {
                    this.showNotification(
                        'ğŸ Match Starting Soon!',
                        'India vs Pakistan starts in 15 minutes\nğŸ• 3:00 PM IST\nğŸŸï¸ Wankhede Stadium',
                        {
                            tag: 'test-15min',
                            requireInteraction: true,
                            vibrate: [300, 100, 300],
                            actions: [
                                { action: 'view', title: 'ğŸ‘€ View Match' },
                                { action: 'remind', title: 'â° Remind Later' }
                            ]
                        }
                    );
                };

                document.getElementById('test5min').onclick = () => {
                    this.showNotification(
                        'â° Match Starting Very Soon!',
                        'India vs Pakistan starts in 5 minutes\nğŸš¨ Get ready to watch!\nğŸ“± Open CricStreamZone now',
                        {
                            tag: 'test-5min',
                            requireInteraction: true,
                            vibrate: [500, 200, 500, 200, 500],
                            actions: [
                                { action: 'watch', title: 'ğŸ”´ Watch Now' },
                                { action: 'dismiss', title: 'âœ• Dismiss' }
                            ]
                        }
                    );
                };

                document.getElementById('testLive').onclick = () => {
                    this.showNotification(
                        'ğŸ”´ LIVE NOW!',
                        'India vs Pakistan is now LIVE!\nâš¡ Don\'t miss the action!\nğŸ Toss won by India',
                        {
                            tag: 'test-live',
                            requireInteraction: true,
                            vibrate: [1000, 300, 1000],
                            actions: [
                                { action: 'watch', title: 'ğŸ¯ Watch Live' },
                                { action: 'score', title: 'ğŸ“Š Live Score' }
                            ]
                        }
                    );
                };

                document.getElementById('testEnd').onclick = () => {
                    this.showNotification(
                        'ğŸ Match Finished',
                        'India vs Pakistan has ended\nğŸ† India won by 6 wickets\nğŸ“Š Check highlights and final scores',
                        {
                            tag: 'test-end',
                            requireInteraction: false,
                            actions: [
                                { action: 'highlights', title: 'ğŸ¬ Highlights' },
                                { action: 'scorecard', title: 'ğŸ“Š Scorecard' }
                            ]
                        }
                    );
                };

                // Advanced Features
                document.getElementById('testVibration').onclick = () => {
                    this.showNotification(
                        'ğŸ“³ Vibration Test',
                        'This notification includes custom vibration patterns\nğŸ“± Feel the rhythm!',
                        {
                            vibrate: [200, 100, 200, 100, 200, 100, 500, 300, 200],
                            tag: 'vibration-test'
                        }
                    );
                };

                document.getElementById('testActions').onclick = () => {
                    this.showNotification(
                        'âš¡ Action Buttons Test',
                        'This notification includes interactive action buttons\nğŸ‘† Try clicking the buttons below',
                        {
                            tag: 'actions-test',
                            requireInteraction: true,
                            actions: [
                                { action: 'like', title: 'ğŸ‘ Like' },
                                { action: 'share', title: 'ğŸ“¤ Share' },
                                { action: 'close', title: 'âœ• Close' }
                            ]
                        }
                    );
                };

                document.getElementById('testSound').onclick = () => {
                    this.showNotification(
                        'ğŸ”Š Sound Test',
                        'This notification should play the default system sound\nğŸµ Listen carefully!',
                        {
                            silent: false,
                            tag: 'sound-test'
                        }
                    );
                };

                document.getElementById('testBadge').onclick = () => {
                    this.showNotification(
                        'ğŸ·ï¸ Badge Test',
                        'This notification includes a badge icon\nğŸ” Look for the small icon in notification area',
                        {
                            badge: 'https://i.postimg.cc/3rPWWckN/icon-192.png',
                            tag: 'badge-test'
                        }
                    );
                };

                // Utilities
                document.getElementById('clearAll').onclick = () => {
                    this.log.innerHTML = '<div>ğŸ“‹ Test log cleared - Ready for new tests...</div>';
                    this.addLog('ğŸ—‘ï¸ All logs cleared');
                };

                document.getElementById('testAll').onclick = () => this.runAllTests();
                document.getElementById('exportLog').onclick = () => this.exportLog();
            }
        }

        // Initialize tester when page loads
        let tester;
        
        document.addEventListener('DOMContentLoaded', () => {
            tester = new NotificationTester();
        });

        // Handle Service Worker messages
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.addEventListener('message', event => {
                const { action, data } = event.data || {};
                
                if (tester) {
                    switch (action) {
                        case 'notificationClick':
                            tester.addLog(`ğŸ–±ï¸ Service Worker notification clicked: ${data.title}`, 'success');
                            break;
                        case 'notificationClose':
                            tester.addLog(`âŒ Service Worker notification closed: ${data.title}`);
                            break;
                        case 'actionClick':
                            tester.addLog(`âš¡ Action clicked: ${data.action} on ${data.title}`, 'success');
                            break;
                    }
                }
            });
        }

        // Handle page visibility change
        document.addEventListener('visibilitychange', () => {
            if (tester) {
                if (document.hidden) {
                    tester.addLog('ğŸ‘ï¸ Page hidden - Testing background notifications');
                } else {
                    tester.addLog('ğŸ‘ï¸ Page visible - Back to foreground');
                }
            }
        });

        // Handle online/offline status
        window.addEventListener('online', () => {
            if (tester) tester.addLog('ğŸŒ Back online', 'success');
        });

        window.addEventListener('offline', () => {
            if (tester) tester.addLog('ğŸ“¡ Gone offline', 'warning');
        });

        // Global error handler
        window.addEventListener('error', (event) => {
            if (tester) {
                tester.addLog(`âŒ JavaScript Error: ${event.message}`, 'error');
            }
        });

        // Unhandled promise rejection handler
        window.addEventListener('unhandledrejection', (event) => {
            if (tester) {
                tester.addLog(`âŒ Unhandled Promise Rejection: ${event.reason}`, 'error');
            }
        });

        console.log('ğŸ”” CricStreamZone Notification Test Page Loaded');
    </script>
</body>
</html>
