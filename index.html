          let finishedCount = 0;

          matches.forEach(m => {
            const duration = parseInt(m.MatchDuration) || 360;
            const status = getMatchStatus(m.MatchTime, duration, now);
            const ct = new Date(m.MatchTime);
            
            if (status === 'live' || status === 'coming_soon') {
              liveCount++;
            } else if (status === 'finished') {
              finishedCount++;
            } else if (ct >= todayStart && ct < todayEnd) {
              todayCount++;
            } else if (ct > todayEnd) {
              upcomingCount++;
            }
          });
          
          document.getElementById("countLive").innerText = `(${liveCount})`;
          document.getElementById("countToday").innerText = `(${todayCount})`;
          document.getElementById("countUpcoming").innerText = `(${upcomingCount})`;
          document.getElementById("countFinished").innerText = `(${finishedCount})`;
          
          renderMatches(currentSubTab);
        }
      })
      .catch(e => console.error('Auto-refresh error:', e));
  }
}, 30000);

// Prevent context menu on match cards
document.addEventListener('contextmenu', function(e) {
  if (e.target.closest('.match')) {
    e.preventDefault();
  }
});

// Add loading animation
function showLoading() {
  document.getElementById('match-list').innerHTML = `
    <div style="
      display: flex;
      justify-content: center;
      align-items: center;
      height: 200px;
      flex-direction: column;
      gap: 15px;
    ">
      <div style="
        width: 40px;
        height: 40px;
        border: 4px solid #333;
        border-top: 4px solid #0af;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      "></div>
      <div style="color: #ccc; font-size: 14px;">Loading matches...</div>
    </div>
    <style>
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
    </style>
  `;
}

// Show loading initially
showLoading();

// Add smooth scroll behavior
document.documentElement.style.scrollBehavior = 'smooth';

// Network status monitoring
function updateNetworkStatus() {
  if ('navigator' in window && 'onLine' in navigator) {
    if (!navigator.onLine) {
      const offlineNotice = document.createElement('div');
      offlineNotice.id = 'offline-notice';
      offlineNotice.innerHTML = 'üì° You are offline. Some features may not work.';
      offlineNotice.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        background: #ff6b35;
        color: white;
        text-align: center;
        padding: 10px;
        z-index: 9999;
        font-size: 14px;
        font-weight: 600;
      `;
      document.body.appendChild(offlineNotice);
    } else {
      const existingNotice = document.getElementById('offline-notice');
      if (existingNotice) {
        existingNotice.remove();
      }
    }
  }
}

window.addEventListener('online', updateNetworkStatus);
window.addEventListener('offline', updateNetworkStatus);
updateNetworkStatus();

// Push notification for new live matches
let lastLiveMatchCount = 0;

function checkForNewLiveMatches() {
  const now = new Date();
  let currentLiveCount = 0;
  
  matches.forEach(m => {
    const duration = parseInt(m.MatchDuration) || 360;
    const status = getMatchStatus(m.MatchTime, duration, now);
    
    if (status === 'live' || status === 'coming_soon') {
      currentLiveCount++;
    }
  });
  
  // Send notification if new live match detected
  if (currentLiveCount > lastLiveMatchCount && lastLiveMatchCount > 0) {
    OneSignal.push(function() {
      OneSignal.isPushNotificationsEnabled(function(isEnabled) {
        if (isEnabled) {
          // Find the new live match
          const newLiveMatches = matches.filter(m => {
            const duration = parseInt(m.MatchDuration) || 360;
            const status = getMatchStatus(m.MatchTime, duration, now);
            return status === 'live' || status === 'coming_soon';
          });
          
          if (newLiveMatches.length > 0) {
            const match = newLiveMatches[0];
            showNotificationMessage(`üî¥ LIVE: ${match.Team1} vs ${match.Team2} - ${match.Match}`, "success");
          }
        }
      });
    });
  }
  
  lastLiveMatchCount = currentLiveCount;
}

// Check for new live matches every minute
setInterval(checkForNewLiveMatches, 60000);

// Background sync for notifications
if ('serviceWorker' in navigator && 'sync' in window.ServiceWorkerRegistration.prototype) {
  navigator.serviceWorker.ready.then(function(registration) {
    return registration.sync.register('background-sync');
  }).catch(function(error) {
    console.log('Background sync registration failed:', error);
  });
}

// Visibility change handler for background notifications
document.addEventListener('visibilitychange', function() {
  if (document.hidden) {
    // App is in background
    console.log('App moved to background');
  } else {
    // App is in foreground
    console.log('App moved to foreground');
    // Refresh data when app comes back to foreground
    if (document.getElementById('subTabs').style.display === 'block') {
      fetch(matchesApi)
        .then(res => res.json())
        .then(data => {
          matches = data.matches || [];
          renderMatches(currentSubTab);
        })
        .catch(e => console.error('Foreground refresh error:', e));
    }
  }
});

// Page focus/blur events for better background handling
window.addEventListener('focus', function() {
  console.log('Window focused');
  // Update notification status when window gets focus
  OneSignal.push(function() {
    OneSignal.isPushNotificationsEnabled(function(isEnabled) {
      updateNotificationStatus(isEnabled);
    });
  });
});

window.addEventListener('blur', function() {
  console.log('Window blurred');
});

// Handle page unload for cleanup
window.addEventListener('beforeunload', function() {
  clearIntervals();
});

// Error handling for OneSignal
window.addEventListener('error', function(e) {
  if (e.message && e.message.includes('OneSignal')) {
    console.error('OneSignal error:', e);
    showNotificationMessage("‚ö†Ô∏è Notification service temporarily unavailable", "error");
  }
});

// Initialize notification check after page load
window.addEventListener('load', function() {
  setTimeout(() => {
    checkForNewLiveMatches();
  }, 5000);
});

// Handle notification permission changes in real-time
if ('permissions' in navigator) {
  navigator.permissions.query({name: 'notifications'}).then(function(result) {
    result.addEventListener('change', function() {
      OneSignal.push(function() {
        OneSignal.isPushNotificationsEnabled(function(isEnabled) {
          updateNotificationStatus(isEnabled);
        });
      });
    });
  });
}

// Custom notification sound (optional)
function playNotificationSound() {
  try {
    const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIG2m98OScTgwOUarm7blmGgU7k9n1unEiBC13yO/eizEIHWq+8+OWT');
    audio.volume = 0.3;
    audio.play().catch(e => console.log('Audio play failed:', e));
  } catch (e) {
    console.log('Audio creation failed:', e);
  }
}

// Enhanced notification with sound
function sendEnhancedNotification(title, message, icon) {
  if ('Notification' in window && Notification.permission === 'granted') {
    const notification = new Notification(title, {
      body: message,
      icon: icon || 'https://i.postimg.cc/3rPWWckN/icon-192.png',
      badge: 'https://i.postimg.cc/3rPWWckN/icon-192.png',
      tag: 'cricstreamzone-match',
      requireInteraction: true,
      silent: false
    });
    
    notification.onclick = function() {
      window.focus();
      notification.close();
    };
    
    // Play sound
    playNotificationSound();
    
    // Auto close after 10 seconds
    setTimeout(() => {
      notification.close();
    }, 10000);
  }
}

// Test notification function (for debugging)
function testNotification() {
  OneSignal.push(function() {
    OneSignal.isPushNotificationsEnabled(function(isEnabled) {
      if (isEnabled) {
        sendEnhancedNotification(
          "üèè CricStreamZone Test",
          "Notifications are working perfectly!",
          "https://i.postimg.cc/3rPWWckN/icon-192.png"
        );
        showNotificationMessage("‚úÖ Test notification sent!", "success");
      } else {
        showNotificationMessage("‚ùå Notifications are disabled", "error");
      }
    });
  });
}

// Add test notification to drawer (for debugging - remove in production)
// Uncomment the line below to add test notification option in drawer
// document.querySelector('#drawer h3').insertAdjacentHTML('afterend', '<a href="#" onclick="testNotification(); toggleDrawer();">üß™ Test Notification</a>');

console.log('üîî OneSignal Push Notification System Loaded Successfully!');
console.log('üì± App ID:', '8305d6bc-7596-4ac0-807b-43d2ae7d9ef8');
console.log('‚úÖ Background notifications enabled');
console.log('üéØ Auto-subscription enabled');
console.log('üîÑ Real-time match updates enabled');

</script>

</body>
</html>
